<script>
    const SERVER = "https://indication-viii-coalition-litigation.trycloudflare.com"; // ACTUALIZA ESTO
    const socket = io(SERVER, { transports: ['polling'] });
    
    // Inicialización global para evitar errores de undefined
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let analyser = audioCtx.createAnalyser();
    let dataArray = new Uint8Array(analyser.frequencyBinCount);
    let cryptoKey, isMicLocked = false, sosTimer;

    async function deriveKey(p) {
        const enc = new TextEncoder();
        const bk = await crypto.subtle.importKey("raw", enc.encode(p), "PBKDF2", false, ["deriveKey"]);
        return crypto.subtle.deriveKey({ name: "PBKDF2", salt: enc.encode("v15-salt"), iterations: 100000, hash: "SHA-256" }, bk, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
    }

    async function encrypt(d) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, d);
        return { iv: Array.from(iv), ciphertext: Array.from(new Uint8Array(ct)) };
    }

    async function decrypt(iv, d) {
        try { return await crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(iv) }, cryptoKey, new Uint8Array(d)); } catch(e) { return null; }
    }

    async function startApp() {
        const p = document.getElementById('pass-in').value;
        if(!p) return alert("Clave requerida");
        if(audioCtx.state === 'suspended') audioCtx.resume();
        cryptoKey = await deriveKey(p);
        socket.emit('join-room', { 
            nickname: document.getElementById('nick-in').value, 
            roomName: document.getElementById('room-in').value, 
            password: p 
        });
    }

    socket.on('joined-success', d => { 
        document.getElementById('auth-overlay').style.display='none'; 
        document.getElementById('room-disp').innerText = d.roomName.toUpperCase(); 
        initVisualizer(); 
    });

    function toggleUsers() {
        const box = document.getElementById('user-list-box');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }

    socket.on('user-list', list => {
        document.getElementById('user-names').innerHTML = list.map(u => `• ${u}`).join('<br>');
    });

    // Lógica SOS corregida
    const sosBtn = document.getElementById('sos-trigger');
    sosBtn.onmousedown = sosBtn.ontouchstart = (e) => {
        if(e.cancelable) e.preventDefault();
        sosTimer = setTimeout(() => {
            navigator.geolocation.getCurrentPosition(p => socket.emit('sos-alert', `${p.coords.latitude},${p.coords.longitude}`), () => socket.emit('sos-alert', null));
        }, 2000);
    };
    sosBtn.onmouseup = sosBtn.ontouchend = () => clearTimeout(sosTimer);

    socket.on('sos-activated', d => {
        document.body.classList.add('sos-active');
        playTone(800, 1);
        const chat = document.getElementById('chat'); 
        chat.innerHTML += `<div class="msg" style="border-left-color:red; background:rgba(255,0,0,0.1)"><b>⚠️ SOS DE ${d.user}</b><br>${d.coords || 'Sin GPS'}</div>`;
        chat.scrollTop = chat.scrollHeight;
        setTimeout(() => document.body.classList.remove('sos-active'), 4000);
    });

    socket.on('channel-busy', u => { 
        const b = document.getElementById('talk-btn'); 
        b.innerText = "OCUPADO: " + u; 
        b.style.opacity = "0.5"; 
        isMicLocked = true; 
    });

    socket.on('channel-free', () => { 
        const b = document.getElementById('talk-btn'); 
        b.innerText = "HABLAR"; 
        b.style.opacity = "1"; 
        isMicLocked = false; 
        playTone(1200, 0.2); 
    });

    function playTone(freq, dur) { 
        try {
            const o = audioCtx.createOscillator(); 
            const g = audioCtx.createGain(); 
            o.frequency.value = freq; 
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur); 
            o.connect(g); g.connect(audioCtx.destination); 
            o.start(); o.stop(audioCtx.currentTime + dur); 
        } catch(e){}
    }

    function initVisualizer() {
        analyser.fftSize = 64; 
        draw();
    }

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        const c = document.getElementById('visualizer'); 
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width, c.height);
        dataArray.forEach((v, i) => { 
            ctx.fillStyle = `rgba(0,255,61,${v/255})`; 
            ctx.fillRect(i*12, c.height-(v/2), 10, v/2); 
        });
    }

    socket.on('audio-stream', async d => {
        const dec = await decrypt(d.buffer.iv, d.buffer.ciphertext);
        if(dec && dec.byteLength > 0) {
            document.getElementById('voice-id').innerText = "REC: " + d.user;
            const audio = new Audio(URL.createObjectURL(new Blob([dec], {type:'audio/webm'})));
            const src = audioCtx.createMediaElementSource(audio); 
            src.connect(analyser); analyser.connect(audioCtx.destination);
            audio.play().catch(e => {});
            audio.onended = () => document.getElementById('voice-id').innerText = "RECEPTOR: IDLE";
        }
    });

    // --- SECCIÓN MICRÓFONO BLINDADA ---
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const btn = document.getElementById('talk-btn');
        let rec;
        
        // Noise Gate
        const source = audioCtx.createMediaStreamSource(stream);
        const processor = audioCtx.createScriptProcessor(2048, 1, 1);
        processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0); 
            let sum = 0;
            for (let i = 0; i < input.length; i++) sum += input[i] * input[i];
            window.isQuiet = Math.sqrt(sum / input.length) < 0.012;
        };
        source.connect(processor);
        processor.connect(audioCtx.destination);

        btn.onmousedown = btn.ontouchstart = (e) => {
            if(e.cancelable) e.preventDefault();
            if(isMicLocked) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            socket.emit('request-mic');
        };

        socket.on('mic-granted', () => {
            btn.classList.add('recording'); 
            btn.innerText = "EMITIENDO...";
            rec = new MediaRecorder(stream);
            rec.ondataavailable = async ev => {
                if (window.isQuiet) return;
                const enc = await encrypt(await ev.data.arrayBuffer());
                socket.emit('audio-chunk', enc);
            };
            rec.start(400);
        });

        btn.onmouseup = btn.ontouchend = btn.onmouseleave = () => {
            if(rec && rec.state !== 'inactive') { 
                rec.stop(); 
                socket.emit('release-mic'); 
                btn.classList.remove('recording'); 
            }
        };
    }).catch(err => alert("Error acceso micro: " + err));

    function send() { 
        const i = document.getElementById('msg-in'); 
        if(i.value.trim()){ socket.emit('chat-message', i.value); i.value = ""; } 
    }

    socket.on('chat-message', d => { 
        const chat = document.getElementById('chat'); 
        const div = document.createElement('div'); 
        div.className='msg'; 
        div.innerHTML=`<b>${d.user}:</b> ${d.text}`; 
        chat.appendChild(div); 
        chat.scrollTop = chat.scrollHeight; 
    });
</script>
