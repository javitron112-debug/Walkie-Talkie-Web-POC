<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHANTOM V17</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; text-align: center; }
        #talk-btn { 
            width: 80%; height: 150px; margin-top: 50px; 
            background: #444; border: 5px solid #0f0; color: #0f0;
            font-size: 20px; font-weight: bold; border-radius: 20px;
            touch-action: none;
        }
        #talk-btn:active { background: #f00; color: #fff; }
        input { background: #111; color: #0f0; border: 1px solid #0f0; padding: 10px; margin: 5px; }
    </style>
</head>
<body>

    <h2>RADIO PHANTOM V17</h2>
    <div id="setup">
        <input type="text" id="nick" placeholder="NICKNAME" value="OPERADOR1">
        <input type="text" id="room" placeholder="CANAL" value="ZONA1">
        <button onclick="start()">CONECTAR</button>
    </div>

    <div id="radio" style="display:none;">
        <p id="status">CONECTADO</p>
        <button id="talk-btn">MANTENER PARA HABLAR</button>
    </div>

<script>
    let socket, mediaRecorder, stream;
    const SERVER_URL = "https://handbags-karaoke-choices-revolution.trycloudflare.com"; // CAMBIA ESTO

    async function start() {
        socket = io(SERVER_URL);
        const roomName = document.getElementById('room').value;
        const nickname = document.getElementById('nick').value;

        socket.emit('join-room', { roomName, nickname });

        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        document.getElementById('setup').style.display = 'none';
        document.getElementById('radio').style.display = 'block';

        const btn = document.getElementById('talk-btn');

        // FUNCIÓN GRABAR
        btn.onmousedown = btn.ontouchstart = () => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = async (e) => {
                const buffer = await e.data.arrayBuffer();
                socket.emit('audio-chunk', { room: roomName, buffer: buffer });
            };
            mediaRecorder.start();
            btn.innerText = "TRANSMITIENDO...";
        };

        // FUNCIÓN PARAR
        btn.onmouseup = btn.ontouchend = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                btn.innerText = "MANTENER PARA HABLAR";
            }
        };

        // FUNCIÓN RECIBIR
        socket.on('audio-stream', (buffer) => {
            const blob = new Blob([buffer], { type: 'audio/webm; codecs=opus' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play().catch(err => console.log("Error autoplay:", err));
        });
    }
</script>
</body>
</html>
